<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vaul - Gestor de Contraseñas</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    html {scroll-behavior: smooth;}
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 1rem; display: flex; align-items: center; justify-content: center; color-scheme: light only;}
    .container {background: rgba(255,255,255,0.97); backdrop-filter: blur(12px); border-radius: 22px; padding: 2rem; width: 100%; max-width: 600px; box-shadow: 0 24px 48px rgba(0,0,0,0.13); color: #333; transition: box-shadow 0.3s; position: relative;}
    .container:focus-within {box-shadow: 0 0 0 3px #764ba2, 0 24px 48px rgba(0,0,0,0.13);}
    .theme-switcher {position:absolute; top:18px; right:24px; z-index:10;}
    .switch {display:inline-flex;align-items:center;cursor:pointer;}
    .switch input {display:none;}
    .slider {width:36px;height:18px;background:#e2e8f0;border-radius:12px;position:relative;transition:background 0.3s;margin-right:0.5em;}
    .slider:before {content:""; position:absolute;left:3px;top:3px;width:12px;height:12px;border-radius:50%;background:#667eea;transition:0.3s;}
    .switch input:checked + .slider {background:#764ba2;}
    .switch input:checked + .slider:before {transform:translateX(16px);background:#fff;}
    .header {text-align:center;margin-bottom:2rem;user-select:none;}
    .header h1 {color:#4a5568; font-size:2.5rem; margin-bottom:0.5rem; font-weight:700; letter-spacing:1px; display:flex; align-items:center; justify-content:center; gap:0.7rem;}
    .header .subtitle {color:#718096;font-size:1.1rem;font-weight:500;}
    .form-group {position:relative;margin-bottom:1.5rem;}
    .form-group i {position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#a0aec0;z-index:1;pointer-events:none;}
    input, textarea {width: 100%; padding: 1rem 1rem 1rem 3rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s, background 0.3s; background: #f7fafc; color: #2d3748;}
    input:focus, textarea:focus {outline:2px solid #667eea; border-color:#667eea; background:#fff; box-shadow:0 0 0 3px rgba(102,126,234,0.12);}
    input[aria-invalid="true"], textarea[aria-invalid="true"] {border-color: #e53e3e; background: #fff5f5;}
    .password-input-group input {padding-right:5.5rem !important;}
    .password-input-group button {background:none; border:none; color:#667eea; font-size:1.1rem; cursor:pointer; transition:color 0.2s; padding:0;}
    .password-input-group button:hover {color:#764ba2;}
    .btn {width:100%; padding:1rem; border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer; transition: box-shadow 0.2s, transform 0.2s, background 0.3s; display:flex; align-items:center; justify-content:center; gap:0.5rem; margin-bottom:1rem; outline:none; position:relative;}
    .btn:active {transform:scale(0.98);}
    .btn:focus-visible {box-shadow:0 0 0 3px #764ba2;}
    .btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.18);}
    .btn-primary:hover, .btn-primary:focus-visible {background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); box-shadow: 0 10px 22px rgba(102, 126, 234, 0.24);}
    .btn-secondary {background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; box-shadow: 0 2px 6px rgba(160, 174, 192, 0.04);}
    .btn-secondary:hover, .btn-secondary:focus-visible {background: #edf2f7; border-color: #cbd5e0;}
    .btn-danger {background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; box-shadow: 0 4px 16px rgba(245, 101, 101, 0.16);}
    .btn-danger:hover, .btn-danger:focus-visible {background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); box-shadow: 0 10px 22px rgba(245, 101, 101, 0.22);}
    .btn-link {background: none; color: #667eea; text-decoration: underline; font-size: 0.95rem; padding: 0.5rem; margin: 0; width: auto; box-shadow: none; border: none;}
    .btn-link:hover, .btn-link:focus-visible {color: #764ba2; background: none; text-decoration: underline wavy;}
    .btn-small {width: auto; padding: 0.5rem 1rem; font-size: 0.95rem; margin: 0 0.25rem;}
    .btn[disabled] {opacity:0.7;cursor:not-allowed;filter:grayscale(0.2);}
    .hidden {display:none !important;}
    .auth-container {text-align:center;}
    .main-container {animation: fadeIn 0.5s ease-in;}
    @keyframes fadeIn {from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    .section {background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 7px rgba(0,0,0,0.04);}
    .section h2 {color: #2d3748; margin-bottom: 1rem; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700;}
    .password-card {background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 1.5rem; margin-bottom: 1rem; border-radius: 12px; border-left: 4px solid #667eea; transition: transform 0.22s, box-shadow 0.22s, border-color 0.3s; position: relative; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.09);}
    .password-card:hover, .password-card:focus-within {transform: translateX(4px) scale(1.01); box-shadow: 0 12px 28px rgba(102, 126, 234, 0.13); border-color: #764ba2;}
    .password-info {margin-bottom:1rem;}
    .password-title {font-size: 1.15rem; font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; letter-spacing: 0.1px;}
    .password-value {background: #4a5568; color: white; padding: 0.75rem; border-radius: 8px; font-family: 'Courier New', monospace; letter-spacing: 0.5px; word-break: break-all; position: relative; display: flex; align-items: center; gap: 0.5rem; font-size: 1.08rem; transition: background 0.3s;}
    .password-value:focus-within {outline:2px solid #667eea;background:#2d3748;}
    .card-actions {display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;}
    .toast {position: fixed; top: 24px; right: 24px; background: #48bb78; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.16); z-index: 1000; animation: slideIn 0.3s cubic-bezier(0.4, 0.6, 0.5, 1.2); font-size: 1rem; display: flex; align-items: center; gap: 0.7rem;}
    @keyframes slideIn {from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}
    .empty-state {text-align:center;padding:3rem 1rem;color:#718096;}
    .empty-state i {font-size: 3rem; margin-bottom: 1rem; color: #cbd5e0; animation: floatIcon 2s infinite ease-in-out alternate;}
    @keyframes floatIcon {from{transform:translateY(0);}to{transform:translateY(-8px);}}
    .user-info {background: #e6fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; font-size: 1rem; border: 1.5px solid #b2f5ea;}
    .user-email {color:#2d3748;font-weight:500;display:flex;align-items:center;gap:0.5rem;word-break:break-all;}
    .back-link {display:flex;align-items:center;gap:0.5rem;color:#667eea;text-decoration:none;margin-bottom:1rem;font-size:0.98rem;font-weight:500;transition:color 0.2s;}
    .back-link:hover, .back-link:focus-visible {color:#764ba2;text-decoration:underline;}
    .recovery-info {background: #f0f8ff; border: 2px solid #e6f3ff; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;}
    .recovery-info i {font-size:2rem;color:#667eea;margin-bottom:0.5rem;}
    .recovery-info p {color:#4a5568;font-size:0.95rem;line-height:1.4;}
    @media (max-width:768px){.container {margin:0;border-radius:0;min-height:100vh;display:flex;flex-direction:column;justify-content:center;padding:1rem;max-width:100vw;} .header h1 {font-size:2rem;} .card-actions {justify-content:center;} .toast {right:8px;left:8px;width:calc(100vw - 16px);}}
    @media (max-width:480px){.container {padding:0.2rem;} .main-container, .section {padding:1rem 0.4rem;} .header h1 {font-size:1.5rem;}}
    body.dark {background: linear-gradient(135deg, #232946 0%, #321e4f 100%) !important; color: #f4f4f4 !important;}
    body.dark .container {background:rgba(32,32,64,0.96)!important;color:#f4f4f4;}
    body.dark input, body.dark textarea {background:#2a2a40;color:#f4f4f4;border-color:#444;}
    body.dark .section, body.dark .password-card {background:#232946;color:#f4f4f4;}
    body.dark .btn-primary {background: linear-gradient(135deg,#9167ea 0%,#764ba2 100%)!important;}
    body.dark .btn-secondary {background:#232946;color:#e7e7ff;}
    body.dark .btn-danger {background:linear-gradient(135deg, #fb5353 0%, #a42121 100%)!important;}
    body.dark .empty-state i {color:#393986;}
    body.dark .toast {background:#7f5af0!important;color:#fff;}
    body.dark .user-info {background:#321e4f;color:#f4f4f4;}
    body.dark .password-value {background:#121221;}
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="theme-switcher">
      <label class="switch" aria-label="Cambiar modo claro/oscuro">
        <input type="checkbox" id="themeToggle" aria-checked="false">
        <span class="slider"></span>
        <i class="fas fa-moon" style="margin-left:6px;color:#764ba2;"></i>
      </label>
    </div>
    <div class="header" aria-label="Título principal">
      <h1><i class="fas fa-shield-alt" aria-hidden="true"></i> Vaul</h1>
      <p class="subtitle">Tu gestor de contraseñas seguro</p>
    </div>
    <!-- Pantalla de Login -->
    <div id="auth" class="auth-container" aria-label="Formulario de autenticación">
      <div class="section" aria-labelledby="login-title">
        <div class="form-group">
          <i class="fas fa-envelope" aria-hidden="true"></i>
          <input type="email" id="email" placeholder="Correo electrónico" autocomplete="username" aria-label="Correo electrónico" required />
        </div>
        <div class="form-group password-input-group">
          <i class="fas fa-lock" aria-hidden="true"></i>
          <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" aria-label="Contraseña" required />
        </div>
        <button id="loginBtn" class="btn btn-primary" aria-label="Iniciar sesión">
          <i class="fas fa-sign-in-alt"></i>
          Iniciar sesión
        </button>
        <button id="registerBtn" class="btn btn-secondary" aria-label="Registrar cuenta">
          <i class="fas fa-user-plus"></i>
          Registrar cuenta
        </button>
        <button id="forgotPasswordBtn" class="btn btn-link" aria-label="¿Olvidaste tu contraseña?">
          <i class="fas fa-question-circle"></i>
          ¿Olvidaste tu contraseña?
        </button>
      </div>
    </div>
    <!-- Pantalla de Recuperación de Contraseña -->
    <div id="recovery" class="auth-container hidden" aria-label="Recuperación de contraseña">
      <div class="section">
        <a href="#" id="backToLogin" class="back-link" aria-label="Volver al inicio de sesión">
          <i class="fas fa-arrow-left"></i>
          Volver al inicio de sesión
        </a>
        <div class="recovery-info">
          <i class="fas fa-envelope-open-text" aria-hidden="true"></i>
          <h3 style="margin-bottom: 0.5rem; color: #2d3748;">Recuperar Contraseña</h3>
          <p>Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
        </div>
        <div class="form-group">
          <i class="fas fa-envelope" aria-hidden="true"></i>
          <input type="email" id="recoveryEmail" placeholder="Correo electrónico registrado" autocomplete="username" aria-label="Correo electrónico registrado" required />
        </div>
        <button id="sendRecoveryBtn" class="btn btn-primary" aria-label="Enviar enlace de recuperación">
          <i class="fas fa-paper-plane"></i>
          Enviar enlace de recuperación
        </button>
      </div>
    </div>
    <!-- Pantalla Principal -->
    <div id="main" class="main-container hidden" aria-label="Panel principal">
      <div class="user-info" aria-label="Información de usuario">
        <span class="user-email">
          <i class="fas fa-user-circle" aria-hidden="true"></i>
          <span id="userEmail"></span>
        </span>
        <button id="logoutBtn" class="btn btn-danger btn-small" aria-label="Cerrar sesión">
          <i class="fas fa-sign-out-alt"></i>
          Cerrar sesión
        </button>
      </div>
      <div class="section" aria-label="Formulario de contraseña">
        <h2>
          <i class="fas fa-plus-circle" aria-hidden="true"></i>
          <span id="formTitle">Guardar Nueva Contraseña</span>
        </h2>
        <div class="form-group">
          <i class="fas fa-tag" aria-hidden="true"></i>
          <input type="text" id="note" placeholder="Descripción (ej: Gmail, Facebook, etc.)" aria-label="Descripción" maxlength="50" />
        </div>
        <div class="form-group password-input-group" style="position:relative;">
          <i class="fas fa-key" aria-hidden="true"></i>
          <!-- El campo de contraseña es visible por defecto -->
          <input type="text" id="pwd" placeholder="Contraseña" aria-label="Contraseña" maxlength="64" autocomplete="new-password"/>
          <button type="button" id="generatePwd" class="btn btn-link" style="position:absolute;right:0.7rem;top:0.55rem;" tabindex="-1" aria-label="Generar contraseña segura">
            <i class="fas fa-magic"></i>
          </button>
        </div>
        <button id="saveBtn" class="btn btn-primary" aria-label="Guardar contraseña">
          <i class="fas fa-save"></i>
          <span id="saveBtnText">Guardar</span>
        </button>
        <button id="cancelBtn" class="btn btn-secondary hidden" aria-label="Cancelar edición">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
      </div>
      <div class="section" aria-label="Contraseñas guardadas">
        <h2>
          <i class="fas fa-list" aria-hidden="true"></i>
          Contraseñas Guardadas
        </h2>
        <div id="list"></div>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    // ==============================
    // FIREBASE CONFIGURACIÓN
    // ==============================
    const firebaseConfig = {
      apiKey: "AIzaSyDyk6XjQ72k73oza9fkkUxup9GQvDsFT5o",
      authDomain: "weatherwise-aywzg.firebaseapp.com",
      projectId: "weatherwise-aywzg",
      storageBucket: "weatherwise-aywzg.appspot.com",
      messagingSenderId: "699516071771",
      appId: "1:699516071771:web:43f9af033fbad8a738b47e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==============================
    // ELEMENTOS DEL DOM
    // ==============================
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const mainDiv = document.getElementById("main");
    const authDiv = document.getElementById("auth");
    const recoveryDiv = document.getElementById("recovery");
    const recoveryEmailInput = document.getElementById("recoveryEmail");
    const sendRecoveryBtn = document.getElementById("sendRecoveryBtn");
    const backToLoginBtn = document.getElementById("backToLogin");
    const noteInput = document.getElementById("note");
    const pwdInput = document.getElementById("pwd");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const listDiv = document.getElementById("list");
    const userEmailSpan = document.getElementById("userEmail");
    const formTitle = document.getElementById("formTitle");
    const saveBtnText = document.getElementById("saveBtnText");
    const themeToggle = document.getElementById('themeToggle');
    const generatePwd = document.getElementById('generatePwd');

    let currentUserId = null;
    let editingId = null;

    function encrypt(text) {
      return btoa(text);
    }
    function decrypt(text) {
      return atob(text);
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.setAttribute("role", "status");
      toast.setAttribute("aria-live", "polite");
      toast.style.background = type === 'success' ? '#48bb78' : '#f56565';
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3200);
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        showToast('Contraseña copiada al portapapeles');
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Contraseña copiada al portapapapeles');
      }
    }

    function showScreen(screen) {
      authDiv.classList.add('hidden');
      recoveryDiv.classList.add('hidden');
      mainDiv.classList.add('hidden');
      if (screen === 'auth') {
        authDiv.classList.remove('hidden');
      } else if (screen === 'recovery') {
        recoveryDiv.classList.remove('hidden');
      } else if (screen === 'main') {
        mainDiv.classList.remove('hidden');
      }
    }

    forgotPasswordBtn.onclick = () => {
      showScreen('recovery');
      recoveryEmailInput.value = emailInput.value;
      recoveryEmailInput.focus();
    };

    backToLoginBtn.onclick = (e) => {
      e.preventDefault();
      showScreen('auth');
      setTimeout(() => emailInput.focus(), 150);
    };

    sendRecoveryBtn.onclick = () => {
      const email = recoveryEmailInput.value.trim();
      if (!email) {
        showToast("Por favor ingresa tu correo electrónico", 'error');
        recoveryEmailInput.setAttribute("aria-invalid", "true");
        recoveryEmailInput.focus();
        return;
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showToast("Por favor ingresa un correo electrónico válido", 'error');
        recoveryEmailInput.setAttribute("aria-invalid", "true");
        recoveryEmailInput.focus();
        return;
      }
      recoveryEmailInput.removeAttribute("aria-invalid");

      sendRecoveryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      sendRecoveryBtn.disabled = true;

      auth.sendPasswordResetEmail(email)
        .then(() => {
          showToast("Enlace de recuperación enviado. Revisa tu correo electrónico.");
          showScreen('auth');
          recoveryEmailInput.value = '';
        })
        .catch((error) => {
          let errorMessage = "Error al enviar el enlace de recuperación";
          switch (error.code) {
            case 'auth/user-not-found':
              errorMessage = "No existe una cuenta con este correo electrónico";
              break;
            case 'auth/invalid-email':
              errorMessage = "El correo electrónico no es válido";
              break;
            case 'auth/too-many-requests':
              errorMessage = "Demasiados intentos. Intenta de nuevo más tarde";
              break;
            default:
              errorMessage = error.message;
          }
          showToast(errorMessage, 'error');
        })
        .finally(() => {
          sendRecoveryBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar enlace de recuperación';
          sendRecoveryBtn.disabled = false;
        });
    };

    loginBtn.onclick = () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        showToast("Completa correo y contraseña", 'error');
        if (!email) emailInput.setAttribute("aria-invalid", "true");
        if (!password) passwordInput.setAttribute("aria-invalid", "true");
        return;
      }
      emailInput.removeAttribute("aria-invalid");
      passwordInput.removeAttribute("aria-invalid");

      loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesión...';
      loginBtn.disabled = true;

      auth.signInWithEmailAndPassword(email, password)
        .catch(e => {
          let errorMessage = "Error de inicio de sesión";
          switch (e.code) {
            case 'auth/user-not-found':
              errorMessage = "No existe una cuenta con este correo electrónico";
              emailInput.setAttribute("aria-invalid", "true");
              break;
            case 'auth/wrong-password':
              errorMessage = "Contraseña incorrecta";
              passwordInput.setAttribute("aria-invalid", "true");
              break;
            case 'auth/invalid-email':
              errorMessage = "El correo electrónico no es válido";
              emailInput.setAttribute("aria-invalid", "true");
              break;
            case 'auth/user-disabled':
              errorMessage = "Esta cuenta ha sido deshabilitada";
              break;
            case 'auth/too-many-requests':
              errorMessage = "Demasiados intentos fallidos. Intenta más tarde";
              break;
            default:
              errorMessage = e.message;
          }
          showToast(errorMessage, 'error');
          loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesión';
          loginBtn.disabled = false;
        });
    };

    registerBtn.onclick = () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        showToast("Completa correo y contraseña", 'error');
        if (!email) emailInput.setAttribute("aria-invalid", "true");
        if (!password) passwordInput.setAttribute("aria-invalid", "true");
        return;
      }
      if(password.length < 6) {
        showToast("La contraseña debe tener al menos 6 caracteres", 'error');
        passwordInput.setAttribute("aria-invalid", "true");
        return;
      }
      emailInput.removeAttribute("aria-invalid");
      passwordInput.removeAttribute("aria-invalid");

      registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta...';
      registerBtn.disabled = true;

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          showToast("Cuenta creada exitosamente");
          registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Registrar cuenta';
          registerBtn.disabled = false;
        })
        .catch(e => {
          let errorMessage = "Error al crear la cuenta";
          switch (e.code) {
            case 'auth/email-already-in-use':
              errorMessage = "Ya existe una cuenta con este correo electrónico";
              emailInput.setAttribute("aria-invalid", "true");
              break;
            case 'auth/invalid-email':
              errorMessage = "El correo electrónico no es válido";
              emailInput.setAttribute("aria-invalid", "true");
              break;
            case 'auth/weak-password':
              errorMessage = "La contraseña es muy débil";
              passwordInput.setAttribute("aria-invalid", "true");
              break;
            default:
              errorMessage = e.message;
          }
          showToast(errorMessage, 'error');
          registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Registrar cuenta';
          registerBtn.disabled = false;
        });
    };

    logoutBtn.onclick = () => {
      auth.signOut();
    };

    cancelBtn.onclick = () => {
      clearForm();
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserId = user.uid;
        userEmailSpan.textContent = user.email;
        showScreen('main');
        loadPasswords();
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar sesión';
        loginBtn.disabled = false;
        registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Registrar cuenta';
        registerBtn.disabled = false;
        emailInput.removeAttribute("aria-invalid");
        passwordInput.removeAttribute("aria-invalid");
        showWelcome();
      } else {
        currentUserId = null;
        showScreen('auth');
        clearForm();
        listDiv.innerHTML = "";
        emailInput.value = "";
        passwordInput.value = "";
        recoveryEmailInput.value = "";
      }
    });

    saveBtn.onclick = () => {
      const note = noteInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!note || !pwd) {
        showToast("Completa descripción y contraseña", 'error');
        if (!note) noteInput.setAttribute("aria-invalid", "true");
        if (!pwd) pwdInput.setAttribute("aria-invalid", "true");
        return;
      }
      noteInput.removeAttribute("aria-invalid");
      pwdInput.removeAttribute("aria-invalid");

      const data = {
        note: encrypt(note),
        pwd: encrypt(pwd),
        updated: new Date()
      };

      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
      saveBtn.disabled = true;

      if(editingId){
        db.collection("users").doc(currentUserId).collection("passwords").doc(editingId).set(data)
          .then(() => {
            showToast("Contraseña actualizada exitosamente");
            clearForm();
            loadPasswords();
          })
          .catch(e => {
            showToast("Error actualizando: " + e.message, 'error');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar';
            saveBtn.disabled = false;
          });
      } else {
        db.collection("users").doc(currentUserId).collection("passwords").add(data)
          .then(() => {
            showToast("Contraseña guardada exitosamente");
            clearForm();
            loadPasswords();
          })
          .catch(e => {
            showToast("Error guardando: " + e.message, 'error');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
            saveBtn.disabled = false;
          });
      }
    };

    function loadPasswords(){
      listDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Cargando contraseñas...</div>';
      db.collection("users").doc(currentUserId).collection("passwords")
        .orderBy("updated", "desc")
        .get()
        .then(snapshot => {
          listDiv.innerHTML = "";
          if(snapshot.empty){
            listDiv.innerHTML = `
              <div class="empty-state" tabindex="0">
                <i class="fas fa-key" aria-hidden="true"></i>
                <h3>No hay contraseñas guardadas</h3>
                <p>Comienza guardando tu primera contraseña</p>
              </div>
            `;
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            const card = document.createElement("div");
            card.className = "password-card";
            card.setAttribute("tabindex", "0");
            card.setAttribute("data-pwd-id", doc.id);
            card.innerHTML = `
              <div class="password-info">
                <div class="password-title">
                  <i class="fas fa-tag" aria-hidden="true"></i>
                  ${decrypt(data.note)}
                </div>
                <div class="password-value" tabindex="0" aria-label="Contraseña">
                  <span style="flex: 1;">${decrypt(data.pwd)}</span>
                </div>
              </div>
              <div class="card-actions">
                <button onclick="copyPassword('${doc.id}')" class="btn btn-secondary btn-small" aria-label="Copiar contraseña">
                  <i class="fas fa-copy"></i>
                  Copiar
                </button>
                <button onclick="editPwd('${doc.id}')" class="btn btn-primary btn-small" aria-label="Editar contraseña">
                  <i class="fas fa-edit"></i>
                  Editar
                </button>
                <button onclick="deletePwd('${doc.id}')" class="btn btn-danger btn-small" aria-label="Eliminar contraseña">
                  <i class="fas fa-trash"></i>
                  Eliminar
                </button>
              </div>
            `;
            listDiv.appendChild(card);
          });
        })
        .catch(e => {
          listDiv.innerHTML = '<div style="text-align: center; color: #f56565; padding: 2rem;">Error cargando contraseñas</div>';
          showToast("Error cargando: " + e.message, 'error');
        });
    }

    function clearForm(){
      noteInput.value = "";
      pwdInput.value = "";
      pwdInput.type = "text"; // SIEMPRE visible al limpiar
      editingId = null;
      formTitle.textContent = "Guardar Nueva Contraseña";
      saveBtnText.textContent = "Guardar";
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
      saveBtn.disabled = false;
      cancelBtn.classList.add("hidden");
      noteInput.removeAttribute("aria-invalid");
      pwdInput.removeAttribute("aria-invalid");
    }

    window.copyPassword = function(id){
      db.collection("users").doc(currentUserId).collection("passwords").doc(id).get()
        .then(doc => {
          if(!doc.exists) return showToast("Contraseña no encontrada", 'error');
          const data = doc.data();
          copyToClipboard(decrypt(data.pwd));
          const card = document.querySelector(`[data-pwd-id='${id}']`);
          if(card){
            const btn = card.querySelector(".btn-secondary");
            btn.innerHTML = `<i class="fas fa-check"></i> Copiado`;
            setTimeout(()=>{btn.innerHTML = `<i class="fas fa-copy"></i> Copiar`;},1100);
          }
        })
        .catch(e => showToast("Error al copiar: " + e.message, 'error'));
    };

    window.editPwd = function(id){
      db.collection("users").doc(currentUserId).collection("passwords").doc(id).get()
        .then(doc => {
          if(!doc.exists) return showToast("Contraseña no encontrada", 'error');
          const data = doc.data();
          noteInput.value = decrypt(data.note);
          pwdInput.value = decrypt(data.pwd);
          pwdInput.type = "text"; // visible al editar
          editingId = id;
          formTitle.textContent = "Editar Contraseña";
          saveBtnText.textContent = "Actualizar";
          cancelBtn.classList.remove("hidden");
          document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(e => showToast("Error al cargar para editar: " + e.message, 'error'));
    };

    window.deletePwd = function(id){
      if(confirm("¿Estás seguro de que quieres eliminar esta contraseña? Esta acción no se puede deshacer.")){
        db.collection("users").doc(currentUserId).collection("passwords").doc(id).delete()
          .then(() => {
            showToast("Contraseña eliminada exitosamente");
            loadPasswords();
          })
          .catch(e => showToast("Error eliminando: " + e.message, 'error'));
      }
    };

    emailInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') loginBtn.click();
    });
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') loginBtn.click();
    });
    recoveryEmailInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendRecoveryBtn.click();
    });
    noteInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') pwdInput.focus();
    });
    pwdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') saveBtn.click();
    });

    if(themeToggle){
      if(localStorage.getItem('vaul-theme') === "dark") {
        document.body.classList.add('dark');
        themeToggle.checked = true;
        themeToggle.setAttribute("aria-checked","true");
      }
      themeToggle.onchange = () => {
        if(themeToggle.checked){
          document.body.classList.add('dark');
          localStorage.setItem('vaul-theme',"dark");
          themeToggle.setAttribute("aria-checked","true");
        } else {
          document.body.classList.remove('dark');
          localStorage.setItem('vaul-theme',"light");
          themeToggle.setAttribute("aria-checked","false");
        }
      };
    }

    if(generatePwd && pwdInput){
      generatePwd.onclick = function() {
        pwdInput.value = generateStrongPassword();
        pwdInput.type = "text";
        showToast("Contraseña segura generada");
      };
    }
    function generateStrongPassword() {
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+";
      let pwd = "";
      for(let i=0;i<16;++i) pwd += chars[Math.floor(Math.random()*chars.length)];
      return pwd;
    }

    function showWelcome() {
      if(currentUserId) {
        const user = firebase.auth().currentUser;
        if(user && user.email){
          const welcome = document.createElement("div");
          welcome.className = "toast";
          welcome.style.top = "62px";
          welcome.innerHTML = `<i class="fas fa-smile"></i> ¡Bienvenido/a, <b>${user.email}</b>!`;
          document.body.appendChild(welcome);
          setTimeout(()=>{welcome.remove();}, 2800);
        }
      }
    }
  </script>
</body>
</html>
